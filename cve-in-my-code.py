import requests
import json
import sqlite3
import subprocess
import datetime
import pytz
import timestamp
from dotenv import load_dotenv
import os

script_dir = os.path.dirname(os.path.abspath(__file__))
os.chdir(script_dir)

load_dotenv()
webhook_url = os.getenv("webhook_url")

def get_last_timestamp():
    conn = sqlite3.connect('cve-database.db')
    cursor = conn.cursor()

    cursor.execute("SELECT timestamp_iso FROM timestamps ORDER BY timestamp_iso DESC LIMIT 1")
    result = cursor.fetchone()  # Fetch the first row from the result

    if result:
        last_run_at = result[0]
        #print("Last run timestamp:", last_run_at)
    else:
        print("No previous timestamps found.")

    conn.close()
    return last_run_at

last_run_at = get_last_timestamp()
#last_run_at = "2023-06-13T08:58:48.144931"
current_time_in_iso = timestamp.convert_unix_to_iso(timestamp.current_timestamps_unix())
print("Current Timestamp in ISO:",current_time_in_iso + "\nLast run at:", last_run_at)

def download_data():
    url = f"https://services.nvd.nist.gov/rest/json/cves/2.0/?pubStartDate={last_run_at}&pubEndDate={current_time_in_iso}&resultsPerPage=2000"  

    response = requests.get(url)

    if response.status_code == 200:
        data = response.json()
        with open("downloaded_json_file.json", "w") as file:
            json.dump(data, file)
        print(f"Downloaded cve data from {last_run_at} to {current_time_in_iso} in downloaded_json_file.json")

    else:
        print(f"Error: {response.status_code} - {response.reason}")

download_data()
number_of_cves = subprocess.check_output("cat downloaded_json_file.json| jq -r '.vulnerabilities[].cve.id'", shell=True).decode().strip()
number_of_cves = len(number_of_cves.splitlines())
print(f"Number of CVEs found in the give date range are {number_of_cves}")

def send_slack_notification(webhook_url, message):
    payload = {
        'text': message
    }
    response = requests.post(webhook_url, json=payload)
    if response.status_code != 200:
        print(f"Failed to send Slack notification. Error: {response.status_code} - {response.text}")

def insert_into_db(webhook_url):
    conn = sqlite3.connect("cve-database.db") 
    cursor = conn.cursor()
    newly_added_cves=0
    new_entries = []

    for i in range(number_of_cves):
        
        cve_id = subprocess.check_output(f"cat downloaded_json_file.json | jq -r '.vulnerabilities[{i}].cve.id'", shell=True).decode().strip()
        cve_desc = subprocess.check_output(f"cat downloaded_json_file.json | jq -r '.vulnerabilities[{i}].cve.descriptions[].value'", shell=True).decode().strip()
        cve_pub_date = subprocess.check_output(f"cat downloaded_json_file.json | jq -r '.vulnerabilities[{i}].cve.published'", shell=True).decode().strip()
        reference_link = subprocess.check_output(f"cat downloaded_json_file.json| jq -r '.vulnerabilities[{i}].cve.references[].url'", shell=True).decode().strip()

        dt = datetime.datetime.strptime(cve_pub_date, "%Y-%m-%dT%H:%M:%S.%f")
        utc_timezone = pytz.timezone("UTC")
        dt_utc = utc_timezone.localize(dt)
        ist_timezone = pytz.timezone("Asia/Kolkata")
        dt_ist = dt_utc.astimezone(ist_timezone)
        ist_timestamp = dt_ist.strftime("%Y-%m-%d %H:%M:%S %Z%z")

        cursor.execute("CREATE TABLE IF NOT EXISTS cve (cve_id TEXT PRIMARY KEY, cve_desc TEXT, cve_pub_date TEXT, reference_link TEXT)")
        
        insert_data = "INSERT OR IGNORE INTO cve (cve_id, cve_desc, cve_pub_date, reference_link) VALUES (?, ?, ?, ?)"
        cursor.execute(insert_data, (cve_id, cve_desc, ist_timestamp, reference_link))
        
        if cursor.rowcount > 0:
            new_entries.append((cve_id, cve_desc, ist_timestamp, reference_link))

    conn.commit()
    cursor.close()
    conn.close()
    
    if len(new_entries) > 0:
        webhook_url = f"{webhook_url}"  
        
        for entry in new_entries:
            newly_added_cves=newly_added_cves+1
            message = "New CVE entries added:\n"
            cve_id, cve_desc, cve_pub_date, reference_link = entry
            
            message += f"{cve_id}\nDescription: {cve_desc}\nPublication Date: {cve_pub_date}\nReferences: {reference_link}\n\n"
            send_slack_notification(webhook_url, message)

    print(f"Total number of newly added CVEs are:", newly_added_cves)    

insert_into_db(webhook_url)
timestamp.main()